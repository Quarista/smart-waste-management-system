// import 'package:swms_administration/models/post_model.dart';

// class PostServices {
//   final List<Post> allPosts = [
//     Post(
//       'assets/images/bin5.png',
//       'assets/images/bin3.png',
//       'assets/images/bin8.png',
//       approach:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       category: 'Maintenance',
//       title: 'Reinstallation of Smart Dustbins in Colombo Fort',
//       overview:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: 'assets/images/bin1.png',
//     ),
//     Post(
//       'assets/images/bin6.png',
//       'assets/images/bin7.png',
//       '',
//       approach:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       category: 'Implementation',
//       title: 'Integrating Smart Dustbin Systems to Kalutara',
//       overview:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: 'assets/images/Screenshot 2025-03-09 192257.png',
//     ),
//     Post(
//       'assets/images/bin6.png',
//       'assets/images/bin7.png',
//       '',
//       approach:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       category: 'Implementation',
//       title: 'Integrating Smart Dustbin Systems to Kalutara',
//       overview:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: 'assets/images/Screenshot 2025-03-09 192257.png',
//     ),
//     Post(
//       'assets/images/bin6.png',
//       'assets/images/bin7.png',
//       '',
//       approach:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       category: 'Implementation',
//       title: 'Integrating Smart Dustbin Systems to Kalutara',
//       overview:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: 'assets/images/Screenshot 2025-03-09 192257.png',
//     ),
//     Post(
//       '',
//       'assets/images/Screenshot 2025-03-09 192257.png',
//       'assets/images/Screenshot 2025-03-09 192257.png',
//       approach:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       category: 'Introduction',
//       title: 'Introducing Smart Dustbin Concept to Rural Areas',
//       overview:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: 'assets/images/Screenshot 2025-03-09 192257.png',
//     ),
//     Post(
//       'assets/images/Screenshot 2025-03-09 192257.png',
//       '',
//       '',
//       approach:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       category: 'Renovation',
//       title: 'Implemeting Waterproof Sensors to Our Dustbins',
//       overview:
//           'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed a lobolobortis sed nulla vel mollis. Sed interdum dui utLorem ipsum dolor sobortis sed nulla vel mollis. Sed interdum du sum dolor sit amet, consectetur adipiscing elit. Sed a lobortis erat. Pellentesque auctor nisl enim, non tincidunt erat euismod vel. Duis lobortis sed nulla vel mollis. Sed interdum  ipsum dolor sit amet, consectetur adipiscing elit. Sed a lghk gjhgf rtjfghj fdgjfy rtjhgjghjh',
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: 'assets/images/Screenshot 2025-03-09 192257.png',
//     ),
//   ];

//   void post(
//     final String title,
//     final String category,
//     final String overview,
//     final String approach,
//     final DateTime date,
//     final DateTime time,
//     final String thumbnail,
//     final String? subImage1,
//     final String? subImage2,
//     final String? subImage3,
//   ) {
//     final Post post = Post(
//       subImage1,
//       subImage2,
//       subImage3,
//       approach: approach,
//       category: category,
//       title: title,
//       overview: overview,
//       date: DateTime.now(),
//       time: DateTime.now(),
//       thumbnail: thumbnail,
//     );
//     allPosts.add(post);
//   }
// }

import 'dart:async';

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart';
import 'package:swms_administration/models/post_model.dart';

class PostServices extends ChangeNotifier {
  final List<Post> _allPosts = [];
  final Map<String, Post> _postMap = {};
  List<Post> get allPosts => _allPosts;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  bool isLoading = true;
  String? error;
  StreamSubscription<QuerySnapshot>? _postsSubscription;

  // Constructor to start listening to Firestore
  PostServices() {
    _setupPostsListener();
  }
  void _setupPostListener() {
    _postsSubscription =
        _firestore.collection('post_updates').snapshots().listen((snapshot) {
      final updatedPosts =
          snapshot.docs.map((doc) => Post.fromFirestore(doc)).toList();

      // Update only changed posts
      for (Post newPost in updatedPosts) {
        final existingIndex = _allPosts.indexWhere((b) => b.id == newPost.id);
        if (existingIndex >= 0) {
          _allPosts[existingIndex] = newPost;
        } else {
          _allPosts.add(newPost);
        }
        _postMap[newPost.id] = newPost;
      }

      notifyListeners(); // This is crucial
    });
  }

  Post? getPostByDocumentId(String documentId) => _postMap[documentId];

  // Setup a real-time listener for post data
  void _setupPostsListener() {
    isLoading = true;
    error = null;
    notifyListeners();

    // Cancel any existing subscription
    _postsSubscription?.cancel();

    //Listen to post_updates collection
    _postsSubscription =
        _firestore.collection('post_updates').snapshots().listen((snapshot) {
//Clear existing posts
      allPosts.clear();
      // _firestore.collection('post_updates').orderBy(
      //       'timestamp',
      //       descending: true,
      //     );
      // Process each document
      for (var doc in snapshot.docs) {
        Map<String, dynamic> postData = doc.data() as Map<String, dynamic>;

        // Create a Post object from the Firestore data
        Post post = Post(
          postData['smallImages'],
          title: postData['title'] ?? 'Unknown Post',
          category: postData['category'] ?? 'Unknown',
          overview: postData['overviewText'] ?? '',
          approach: postData['approachText'] ?? '',
          thumbnail: postData['src'] ??
              'https://i.ibb.co/C51TLWKG/Screenshot-2025-03-09-192257.png',
          id: doc.id,
          postData['timestamp'],
        );
        allPosts.add(post);
      }

      // // Sort the allPosts list based on the timestamp field
      // allPosts.sort((a, b) {
      //   final aTimestamp = (snapshot.docs
      //       .firstWhere((doc) => doc.id == a.id)
      //       .data() as Map<String, dynamic>)['timestamp'] as Timestamp?;
      //   final bTimestamp = (snapshot.docs
      //       .firstWhere((doc) => doc.id == b.id)
      //       .data() as Map<String, dynamic>)['timestamp'] as Timestamp?;
      //   return bTimestamp?.compareTo(aTimestamp ?? Timestamp.now()) ?? 0;
      // });
      isLoading = false;
      notifyListeners();
    }, onError: (error) {
      print('Error in posts listener: $error');
      isLoading = false;
      this.error = error.toString();
      _populateDefaultPosts();
      notifyListeners();
    });
  }

  // Clean up resources when no longer needed
  void dispose() {
    _postsSubscription?.cancel();
    super.dispose();
  }

  // Fallback method to populate with default data in case of errors
  void _populateDefaultPosts() {
    allPosts.clear();
    for (int i = 0; i < 5; i++) {
      allPosts.add(Post(
        [],
        title: 'Welcome to the Smart Dustbin System Post Manager',
        category: 'Introduction',
        overview:
            'Welcome to the Smart Dustbin System Post Managerâ€”a gateway into our innovative platform that simplifies managing updates and notifications in the smart waste management ecosystem. This introductory post outlines the core features of the Post Manager and its vital role in streamlining communication, making it easier for administrators and users alike to stay informed about system events.',
        approach:
            'The post adopts a concise and engaging tone, beginning with the challenges of traditional waste management and introducing how our Post Manager solves these issues with intuitive design and seamless integration. It highlights key functionalities, benefits for users, and a sneak peek into future enhancements, inviting readers to explore the evolving potential of smart waste management systems.',
        thumbnail: 'https://i.ibb.co/C51TLWKG/Screenshot-2025-03-09-192257.png',
        id: '${i + 1}',
        Timestamp.now(),
      ));
    }
  }

  // Method to refresh data manually
  void refreshPosts() {
    _setupPostsListener();
  }

  // Method to get a specific bin by ID
  Post? getPostById(String id) {
    try {
      return allPosts.firstWhere((post) => post.id == id);
    } catch (e) {
      return null;
    }
  }

  // Method to search posts by title or category
  List<Post> searchPosts(String query) {
    if (query.isEmpty) {
      return allPosts;
    }

    return allPosts
        .where((post) =>
            post.title.toLowerCase().contains(query.toLowerCase()) ||
            post.category.toLowerCase().contains(query.toLowerCase()))
        .toList();
  }
}
